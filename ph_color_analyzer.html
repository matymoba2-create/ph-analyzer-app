<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de pH por Color</title>
    <!-- Configuraci칩n PWA y para iOS -->
    <!-- Define el color de la barra de estado del navegador -->
    <meta name="theme-color" content="#4f46e5">
    <!-- Habilita el modo de pantalla completa en iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- En un entorno real, aqu칤 ir칤a: <link rel="manifest" href="manifest.json"> -->
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Estilos espec칤ficos para el video/canvas */
        #video, #canvas {
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px; /* Limitar el ancho en desktop */
            height: auto;
            aspect-ratio: 4/3; /* Proporci칩n est치ndar para c치maras */
            object-fit: cover;
        }
        .container {
            min-width: 320px;
        }
    </style>
</head>
<body class="p-4">

    <div class="container bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">
            游빍 Analizador de pH por Color
        </h1>
        <p class="text-center text-gray-600 mb-6">
            Enfoca la tira indicadora de pH y toca "Capturar" para analizar el color.
        </p>

        <!-- 츼rea de Video y Canvas -->
        <div class="relative mb-6 flex justify-center">
            <video id="video" autoplay playsinline class="block"></video>
            <canvas id="canvas" class="hidden"></canvas>
        </div>

        <!-- Controles y Mensajes -->
        <div class="flex flex-col space-y-4">
            <button id="captureButton"
                    class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold text-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Capturar y Analizar Color
            </button>

            <div id="loadingIndicator" class="hidden text-center text-indigo-600 font-medium">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Analizando el color...</span>
                </div>
            </div>

            <!-- Panel de Resultados -->
            <div id="resultPanel" class="hidden bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded-lg mt-4">
                <p class="font-bold text-lg mb-1">Resultado Estimado:</p>
                <div id="resultContent"></div>
            </div>

            <!-- Panel de Errores/Info -->
            <div id="infoMessage" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mt-4">
                Cargando c치mara... Por favor, permite el acceso a la c치mara.
            </div>
        </div>
    </div>

    <script type="module">
        // Importaci칩n de las funciones de Firebase (aunque no se usa Firestore, el entorno lo requiere)
        // Se incluyen las importaciones de auth para cumplir con el protocolo de autenticaci칩n del entorno.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales proporcionadas por el entorno (deben ser usadas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureButton = document.getElementById('captureButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultPanel = document.getElementById('resultPanel');
        const resultContent = document.getElementById('resultContent');
        const infoMessage = document.getElementById('infoMessage');

        // Configuraci칩n de la API de Gemini
        const apiKey = ""; // La clave se proporciona autom치ticamente en este entorno
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let stream = null; // Para almacenar el flujo de la c치mara

        /**
         * 1. Inicializa Firebase y autentica al usuario.
         * Aunque esta app no usa Firestore, es necesario inicializar la autenticaci칩n
         * para cumplir con las directrices del entorno.
         */
        async function initializeAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                getFirestore(app); // Inicializa Firestore (aunque no se use)

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Autenticaci칩n Firebase completada.");
            } catch (error) {
                console.error("Error en la autenticaci칩n Firebase:", error);
            }
        }

        /**
         * 2. Inicia el flujo de la c치mara del usuario.
         */
        async function startCamera() {
            try {
                // Solicitar la c치mara trasera si est치 disponible (preferible para apps m칩viles),
                // o cualquier otra c치mara si no lo est치.
                const constraints = {
                    video: {
                        facingMode: { ideal: "environment" } // Priorizar c치mara trasera
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Ocultar mensaje de info una vez que la c치mara est칠 lista
                video.addEventListener('loadedmetadata', () => {
                    infoMessage.classList.add('hidden');
                    captureButton.disabled = false;
                }, { once: true });

            } catch (err) {
                console.error("Error al acceder a la c치mara:", err);
                infoMessage.textContent = 'Error: No se pudo acceder a la c치mara. Aseg칰rate de que el navegador tenga permiso.';
                infoMessage.classList.remove('bg-yellow-100', 'text-yellow-800');
                infoMessage.classList.add('bg-red-100', 'text-red-800');
                captureButton.disabled = true;
            }
        }

        /**
         * 3. Captura un frame del video y lo convierte a Base64.
         */
        function captureFrame() {
            // Asegurarse de que el canvas tenga el mismo tama침o que el video visible
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Ocultar el video y mostrar el canvas con la imagen capturada temporalmente
            video.classList.add('hidden');
            canvas.classList.remove('hidden');

            // Devolver la imagen capturada como Base64 (PNG)
            return canvas.toDataURL('image/png');
        }

        /**
         * 4. Llama a la API de Gemini para analizar la imagen y estimar el pH.
         * @param {string} base64Image - La imagen capturada en formato base64 con prefijo MIME.
         */
        async function analyzeColor(base64Image) {
            // Extraer solo los datos base64, eliminando el prefijo "data:image/png;base64,"
            const base64Data = base64Image.split(',')[1];
            
            // Configuraci칩n del payload para la llamada a la API
            const systemPrompt = "Eres un qu칤mico experto y analista de color. Tu tarea es analizar el color de la muestra provista en la imagen y estimar el valor de pH de la sustancia bas치ndote en una escala de indicador universal est치ndar (rojo/naranja = 치cido fuerte, amarillo/verde = neutro/치cido d칠bil, azul/morado = base). Responde siempre con el valor de pH estimado (un n칰mero entre 1 y 14) y una breve justificaci칩n en espa침ol, sin usar encabezados markdown.";
            const userQuery = "Analiza el color principal de esta muestra (asume que es una tira de pH o l칤quido con indicador universal) y dime el valor de pH estimado. La justificaci칩n debe ser concisa.";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: "image/png",
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // Intentar con backoff exponencial
            const maxRetries = 5;
            let currentRetry = 0;
            let response;
            
            while (currentRetry < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Salir del bucle si la respuesta es exitosa
                    } else if (response.status === 429) {
                        // Manejo de Tasa Limitada (Throttle)
                        currentRetry++;
                        if (currentRetry >= maxRetries) throw new Error("M치ximo de reintentos alcanzado.");
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Otros errores de respuesta
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                } catch (error) {
                    currentRetry++;
                    if (currentRetry >= maxRetries) throw error; // Re-lanzar error si se acabaron los reintentos
                    const delay = Math.pow(2, currentRetry) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            if (!response || !response.ok) {
                throw new Error("Fallo al contactar al modelo despu칠s de varios reintentos.");
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                return text.trim();
            } else {
                throw new Error("Respuesta del modelo vac칤a o inesperada.");
            }
        }

        /**
         * 5. Maneja el flujo completo al hacer clic en el bot칩n.
         */
        async function handleCapture() {
            captureButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            resultPanel.classList.add('hidden');
            resultContent.innerHTML = '';
            infoMessage.classList.add('hidden');

            try {
                // 1. Capturar la imagen
                const base64Image = captureFrame();

                // 2. Analizar el color con el LLM
                const resultText = await analyzeColor(base64Image);

                // 3. Mostrar el resultado
                resultContent.innerHTML = resultText.replace(/\n/g, '<br>'); // Mantener saltos de l칤nea
                resultPanel.classList.remove('hidden');

            } catch (error) {
                console.error("Error durante la captura o el an치lisis:", error);
                // Mostrar la imagen de error en el panel de resultados
                resultPanel.classList.remove('hidden', 'bg-green-50', 'border-green-500', 'text-green-800');
                resultPanel.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                resultPanel.querySelector('.font-bold').textContent = "Error al Analizar:";
                resultContent.textContent = `Hubo un problema: ${error.message}. Por favor, int칠ntalo de nuevo.`;
            } finally {
                // 4. Resetear la interfaz
                loadingIndicator.classList.add('hidden');
                captureButton.disabled = false;
                
                // Volver a mostrar el video y ocultar el canvas
                canvas.classList.add('hidden');
                video.classList.remove('hidden');
                
                // Restaurar el color del panel si hubo un error previo
                if (resultPanel.classList.contains('bg-red-100')) {
                     resultPanel.classList.remove('bg-red-100', 'border-red-500', 'text-red-800');
                     resultPanel.classList.add('bg-green-50', 'border-green-500', 'text-green-800');
                     resultPanel.querySelector('.font-bold').textContent = "Resultado Estimado:";
                }
            }
        }

        // Inicializaci칩n
        window.onload = () => {
            initializeAuth(); // Autenticaci칩n (protocolo del entorno)
            startCamera(); // Iniciar la c치mara
            captureButton.disabled = true; // Deshabilitar hasta que la c치mara est칠 lista
            captureButton.addEventListener('click', handleCapture);
        };
    </script>

</body>
</html>